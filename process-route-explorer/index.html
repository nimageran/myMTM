<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Process Route Explorer v3</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- XLSX.js for reading Excel in the browser -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <style>
    /* === BASE THEME === */
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      min-height: 100vh;
      color: #e5e7ff;
      /* Deep space background */
      background: radial-gradient(circle at top, #1d1b3a 0%, #050816 40%, #02010a 100%);
      overflow-x: hidden;
    }

    /* Ambient Blobs */
    .bg-blob {
      position: fixed;
      width: 420px;
      height: 420px;
      border-radius: 50%;
      filter: blur(80px);
      opacity: 0.35;
      z-index: 0;
      pointer-events: none;
    }
    .blob-1 { top: -120px; left: -80px; background: #7f5af0; }
    .blob-2 { bottom: -160px; right: -100px; background: #2cb67d; }

    .app-shell {
      position: relative;
      z-index: 1;
      max-width: 1000px;
      margin: 24px auto 60px;
      padding: 16px;
    }

    /* === HEADER === */
    header { margin-bottom: 24px; }
    .app-title {
      font-size: 1.8rem;
      font-weight: 800;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .glow-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #2cb67d;
      box-shadow: 0 0 15px #2cb67d;
    }
    .app-subtitle {
      margin-top: 8px;
      font-size: 0.95rem;
      color: #9ca3ff;
      max-width: 600px;
      line-height: 1.4;
    }

    /* === GLASS PANELS === */
    .glass-panel {
      background: linear-gradient(145deg, rgba(30, 41, 59, 0.9), rgba(15, 23, 42, 0.95));
      border-radius: 16px;
      border: 1px solid rgba(148, 163, 255, 0.15);
      box-shadow: 0 4px 30px rgba(0, 0, 0, 0.5);
      padding: 20px;
      margin-bottom: 20px;
    }

    .panel-header {
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: #a5b4fc;
      margin-bottom: 12px;
      font-weight: 700;
    }

    /* === CONTROLS === */
    .control-row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
    }

    /* Custom File Input */
    .file-label {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 16px;
      border-radius: 8px;
      border: 1px solid rgba(129, 140, 248, 0.4);
      background: rgba(30, 41, 59, 0.6);
      cursor: pointer;
      font-size: 0.9rem;
      transition: all 0.2s;
    }
    .file-label:hover { border-color: #7f5af0; color: #fff; }
    .file-label input { display: none; }

    /* Text Input */
    input[type="text"] {
      background: rgba(15, 23, 42, 0.8);
      border: 1px solid rgba(148, 163, 255, 0.3);
      border-radius: 8px;
      padding: 10px 16px;
      font-size: 1rem;
      color: #fff;
      flex: 1;
      min-width: 200px;
    }
    input[type="text"]:focus {
      outline: none;
      border-color: #7f5af0;
      box-shadow: 0 0 0 2px rgba(127, 90, 240, 0.2);
    }

    /* Action Button */
    .action-btn {
      background: linear-gradient(135deg, #7f5af0, #6246ea);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: transform 0.1s, box-shadow 0.2s;
    }
    .action-btn:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(127, 90, 240, 0.4);
    }
    .action-btn:disabled {
      background: #334155;
      color: #94a3b8;
      cursor: not-allowed;
    }

    /* === SHEET SELECTOR (CHIPS) === */
    .sheet-area {
      margin-top: 16px;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 12px;
      padding: 12px;
      border: 1px solid rgba(255, 255, 255, 0.05);
    }
    .sheet-actions {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
      align-items: center;
    }
    .mini-btn {
      font-size: 0.75rem;
      padding: 4px 10px;
      background: transparent;
      border: 1px solid rgba(148, 163, 255, 0.3);
      color: #a5b4fc;
      border-radius: 4px;
      cursor: pointer;
    }
    .mini-btn:hover { background: rgba(148, 163, 255, 0.1); color: white; }

    .sheet-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      max-height: 200px;
      overflow-y: auto;
    }
    .sheet-chip {
      padding: 6px 12px;
      border-radius: 6px;
      background: #1e293b;
      border: 1px solid #334155;
      color: #94a3b8;
      font-size: 0.8rem;
      cursor: pointer;
      user-select: none;
      transition: all 0.15s;
    }
    .sheet-chip:hover { border-color: #64748b; color: #e2e8f0; }
    
    /* Selected State */
    .sheet-chip.active {
      background: rgba(44, 182, 125, 0.15);
      border-color: #2cb67d;
      color: #2cb67d;
      font-weight: 600;
      box-shadow: 0 0 8px rgba(44, 182, 125, 0.15);
    }

    /* === RESULTS: METRO MAP === */
    .route-card {
      background: rgba(15, 23, 42, 0.6);
      border: 1px solid rgba(148, 163, 255, 0.2);
      border-radius: 12px;
      margin-bottom: 24px;
      overflow: hidden;
    }
    
    .route-header {
      background: rgba(30, 41, 59, 0.5);
      padding: 10px 16px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .route-title {
      font-size: 0.9rem;
      color: #94a3b8;
      font-weight: 600;
      text-transform: uppercase;
    }

    /* The Flow Container */
    .flow-container {
      padding: 20px 20px 20px 30px;
      display: flex;
      flex-direction: column;
    }

    .flow-step {
      position: relative;
      padding-left: 24px; /* Space for the line */
      padding-bottom: 24px;
      border-left: 2px solid rgba(148, 163, 255, 0.2);
    }
    .flow-step:last-child {
      border-left-color: transparent;
      padding-bottom: 0;
    }

    /* The Dot */
    .flow-step::before {
      content: "";
      position: absolute;
      left: -6px; /* Center on 2px border */
      top: 2px;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #0f172a;
      border: 2px solid #64748b;
      z-index: 2;
    }

    /* Connection Variations */
    .flow-step.is-parent::before { border-color: #2cb67d; background: #2cb67d; }
    .flow-step.is-focus::before { 
      border-color: #7f5af0; 
      background: #7f5af0; 
      width: 14px; height: 14px; 
      left: -8px; 
    }
    .flow-step.is-child::before { border-color: #94a3b8; }

    /* The Card Content inside the step */
    .step-label {
      font-size: 0.7rem;
      text-transform: uppercase;
      color: #64748b;
      margin-bottom: 6px;
      letter-spacing: 0.05em;
      font-weight: 700;
    }

    .step-card {
      background: #1e293b;
      border: 1px solid #334155;
      border-radius: 8px;
      padding: 12px;
      transition: all 0.2s;
    }

    /* Focus Card (The middle one) */
    .step-card.focus-card {
      background: linear-gradient(135deg, rgba(127, 90, 240, 0.1), rgba(15, 23, 42, 0.8));
      border-color: #7f5af0;
      box-shadow: 0 0 15px rgba(127, 90, 240, 0.15);
    }

    /* Typography inside cards */
    .part-name {
      font-size: 1.1rem;
      font-weight: 700;
      color: #f1f5f9;
    }
    .part-desc {
      font-size: 0.9rem;
      color: #cbd5e1;
      margin-top: 4px;
    }
    .part-meta {
      margin-top: 8px;
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .meta-tag {
      font-size: 0.75rem;
      padding: 2px 8px;
      border-radius: 4px;
      background: rgba(0,0,0,0.3);
      border: 1px solid rgba(255,255,255,0.1);
      color: #94a3b8;
    }

    /* Clickable Link Styling */
    .clickable-part {
      color: #2cb67d;
      cursor: pointer;
      text-decoration: underline;
      text-decoration-style: dotted;
      text-decoration-thickness: 1px;
      text-underline-offset: 4px;
    }
    .clickable-part:hover {
      color: #4ade80;
      text-decoration-style: solid;
    }

    .status-msg {
      margin-top: 8px;
      font-size: 0.85rem;
      color: #94a3b8;
    }
    .status-msg strong { color: #e2e8f0; }
    .error-msg { color: #f87171; }

  </style>
</head>
<body>

  <div class="bg-blob blob-1"></div>
  <div class="bg-blob blob-2"></div>

  <div class="app-shell">
    <header>
      <div class="app-title">
        <span class="glow-dot"></span>
        Process Route Explorer
      </div>
      <div class="app-subtitle">
        MTM Production Engineering Tool. Load your MBOM, select relevant sheets (Mech/Elec), 
        and trace parts from raw materials up to parent assemblies.
      </div>
    </header>

    <!-- 1. LOAD FILE -->
    <div class="glass-panel">
      <div class="panel-header">1. Load Data</div>
      <div class="control-row">
        <label class="file-label">
          <span>üìÇ Select Excel File</span>
          <input type="file" id="fileInput" accept=".xlsx, .xls">
        </label>
        <button id="parseBtn" class="action-btn" disabled>
          <span>‚öôÔ∏è Parse Selected Sheets</span>
        </button>
      </div>

      <!-- Sheet Selection Grid -->
      <div id="sheetArea" class="sheet-area" style="display:none;">
        <div class="sheet-actions">
          <span style="font-size:0.8rem; color:#94a3b8;">Select Sheets to Scan:</span>
          <button id="btnAll" class="mini-btn">Select All</button>
          <button id="btnNone" class="mini-btn">Select None</button>
        </div>
        <div id="sheetGrid" class="sheet-grid"></div>
      </div>

      <div id="statusLoad" class="status-msg"></div>
    </div>

    <!-- 2. SEARCH -->
    <div class="glass-panel">
      <div class="panel-header">2. Trace Part</div>
      <div class="control-row">
        <input type="text" id="partInput" placeholder="Enter Part Number (e.g. A-12345)" disabled>
        <button id="searchBtn" class="action-btn" disabled>
          <span>üîç Trace Path</span>
        </button>
      </div>
      <div class="status-msg">
        Tip: Click on any <strong>Parent</strong> or <strong>Input</strong> in the results to jump to that part immediately.
      </div>
    </div>

    <!-- 3. RESULTS -->
    <div id="resultsContainer"></div>
  </div>

  <script>
    // === GLOBAL STATE ===
    let workbook = null;
    let nodes = [];       // Flat list of all rows
    let rowsByPart = {};  // Map: PartNumber -> [Node, Node]
    let nodeIndex = {};   // Map: Assembly|Item -> Node (for tree climbing)

    // DOM Elements
    const fileInput = document.getElementById('fileInput');
    const parseBtn = document.getElementById('parseBtn');
    const sheetArea = document.getElementById('sheetArea');
    const sheetGrid = document.getElementById('sheetGrid');
    const btnAll = document.getElementById('btnAll');
    const btnNone = document.getElementById('btnNone');
    const statusLoad = document.getElementById('statusLoad');
    
    const partInput = document.getElementById('partInput');
    const searchBtn = document.getElementById('searchBtn');
    const resultsContainer = document.getElementById('resultsContainer');

    // === 1. FILE LOADING ===
    fileInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;

      statusLoad.innerHTML = "Reading file... please wait.";
      const reader = new FileReader();
      
      reader.onload = function(evt) {
        const data = new Uint8Array(evt.target.result);
        try {
          workbook = XLSX.read(data, {type: 'array'});
          renderSheetSelector(workbook.SheetNames);
          statusLoad.innerHTML = `Loaded <strong>${file.name}</strong>. Select sheets below.`;
          parseBtn.disabled = false;
        } catch (err) {
          console.error(err);
          statusLoad.innerHTML = `<span class="error-msg">Error reading file. Ensure it is a valid Excel file.</span>`;
        }
      };
      reader.readAsArrayBuffer(file);
    });

    function renderSheetSelector(names) {
      sheetArea.style.display = 'block';
      sheetGrid.innerHTML = '';
      
      names.forEach(name => {
        const chip = document.createElement('div');
        chip.className = 'sheet-chip';
        chip.textContent = name;
        chip.dataset.name = name;
        
        // Auto-select likely candidates (Mech, BOM, List)
        const up = name.toUpperCase();
        if (up.includes('MECH') || up.includes('BOM') || up.includes('LIST') || !up.includes('LOG')) {
          chip.classList.add('active');
        }
        
        chip.onclick = () => chip.classList.toggle('active');
        sheetGrid.appendChild(chip);
      });
    }

    btnAll.onclick = () => document.querySelectorAll('.sheet-chip').forEach(c => c.classList.add('active'));
    btnNone.onclick = () => document.querySelectorAll('.sheet-chip').forEach(c => c.classList.remove('active'));

    // === 2. PARSING (THE HEAVY LIFTING) ===
    parseBtn.addEventListener('click', () => {
      const activeChips = document.querySelectorAll('.sheet-chip.active');
      if (activeChips.length === 0) {
        alert("Please select at least one sheet.");
        return;
      }

      statusLoad.innerHTML = "Parsing sheets... this may take a moment.";
      
      // Reset Data
      nodes = [];
      rowsByPart = {};
      nodeIndex = {};

      setTimeout(() => {
        let count = 0;
        
        activeChips.forEach(chip => {
          const sheetName = chip.dataset.name;
          const ws = workbook.Sheets[sheetName];
          if (!ws) return;

          const rows = XLSX.utils.sheet_to_json(ws, {header: 1, defval: null});
          if (!rows || rows.length < 2) return;

          // Find Header Row dynamically
          let headerIdx = -1;
          for(let i=0; i<Math.min(20, rows.length); i++) {
            const r = rows[i] || [];
            // We look for 'Part #' and 'Category' as anchors
            if (r.includes('Part #') && r.includes('Category')) {
              headerIdx = i;
              break;
            }
          }

          if (headerIdx === -1) return; // Skip sheets that don't look like BOMs

          // Map columns
          const header = rows[headerIdx];
          const colMap = {};
          header.forEach((h, idx) => { if(h) colMap[h.trim()] = idx; });

          const getVal = (row, name) => {
             const idx = colMap[name];
             return (idx !== undefined && row[idx]) ? String(row[idx]).trim() : null;
          };

          // Fill-down variables
          let curAsm = null;
          let curAsmDesc = null;

          for(let r=headerIdx+1; r<rows.length; r++) {
            const row = rows[r];
            if (!row) continue;

            // Handle Assembly Context (Fill Down)
            const asmVal = getVal(row, 'ASSEMBLY NO');
            if (asmVal) {
              curAsm = asmVal;
              const desc = getVal(row, 'Description'); 
              // Only update assembly desc if we are on the assembly header line
              if (colMap['ASSEMBLY NO'] !== undefined) curAsmDesc = desc; 
            }

            const part = getVal(row, 'Part #');
            if (part) {
              const node = {
                sheet: sheetName,
                assemblyNo: curAsm,
                assemblyDesc: curAsmDesc, // Note: this might be loose, but acceptable
                part: part,
                category: getVal(row, 'Category'),
                desc: getVal(row, 'Description'),
                item: getVal(row, 'Item'),
                loc: getVal(row, 'Part Location/Process'),
                sec: getVal(row, 'Secondary process'),
                qty: getVal(row, 'Qty')
              };

              nodes.push(node);
              count++;

              // Indexing
              const k = part.toUpperCase();
              if (!rowsByPart[k]) rowsByPart[k] = [];
              rowsByPart[k].push(node);

              if (node.assemblyNo && node.item) {
                nodeIndex[`${node.assemblyNo}|${node.item}`] = node;
              }
            }
          }
        });

        statusLoad.innerHTML = `Success! Parsed <strong>${count}</strong> parts from ${activeChips.length} sheets.`;
        partInput.disabled = false;
        searchBtn.disabled = false;
        partInput.focus();
      }, 50); // Small timeout to allow UI to update text
    });

    // === 3. SEARCH & TRACE LOGIC ===
    
    // Global function for clicking links
    window.jumpToPart = function(p) {
      partInput.value = p;
      performSearch();
    };

    searchBtn.addEventListener('click', performSearch);
    partInput.addEventListener('keydown', (e) => { if(e.key === 'Enter') performSearch(); });

    function performSearch() {
      const raw = partInput.value.trim();
      if (!raw) return;
      const key = raw.toUpperCase();
      
      resultsContainer.innerHTML = '';

      if (!rowsByPart[key]) {
        resultsContainer.innerHTML = `
          <div class="glass-panel" style="text-align:center; color:#fbbf24;">
            No results found for <strong>${raw}</strong>.
          </div>`;
        return;
      }

      const matches = rowsByPart[key];
      matches.forEach((node, index) => {
        const chain = buildChain(node);
        renderChain(chain, index + 1);
      });
    }

    function buildChain(node) {
      // 1. Find Parents (Up the tree)
      const parents = [];
      let current = node;
      
      // Basic loop protection
      let safety = 0;
      while (current && current.item && current.assemblyNo && safety < 20) {
        // Logic: if item is 1.2.3, parent is 1.2
        const parts = current.item.split('.');
        if (parts.length <= 1) break; // Top level
        parts.pop();
        const parentItem = parts.join('.');
        
        const parentNode = nodeIndex[`${current.assemblyNo}|${parentItem}`];
        if (parentNode) {
          parents.push(parentNode);
          current = parentNode;
        } else {
          break;
        }
        safety++;
      }

      // 2. Find Inputs (Down the tree - Raw Materials)
      // We look for other nodes in the SAME assembly whose Item starts with our Item
      // e.g. If we are 1.2, inputs are 1.2.1, 1.2.2 (immediate children)
      const inputs = [];
      if (node.assemblyNo && node.item) {
        const prefix = node.item + '.';
        // We scan the flat list (optimization: could index by assembly to speed this up)
        // Since dataset is likely <10k rows, linear scan of filtered set is okay-ish, 
        // but let's try to be smarter. We can iterate specific assembly bucket if we had one.
        // For now, linear scan is robust enough for typical MBOM sizes.
        
        // Filter: Must be same assembly, Item must start with prefix, 
        // AND should not have *another* dot (direct child only)
        const depth = node.item.split('.').length + 1;
        
        nodes.forEach(n => {
          if (n.assemblyNo === node.assemblyNo && n.item && n.item.startsWith(prefix)) {
             const nDepth = n.item.split('.').length;
             // Only include immediate children (inputs)
             if (nDepth === depth) {
               // Optional: Filter for "Material" categories only? 
               // Nima usually wants everything that goes INTO it.
               inputs.push(n);
             }
          }
        });
      }

      return { node, parents, inputs };
    }

    // === 4. RENDERING (METRO MAP) ===
    function renderChain(data, idx) {
      const { node, parents, inputs } = data;

      const card = document.createElement('div');
      card.className = 'route-card';

      // Header
      card.innerHTML = `
        <div class="route-header">
          <span>Occurrence #${idx}</span>
          <span>${node.sheet}</span>
        </div>
      `;

      const flow = document.createElement('div');
      flow.className = 'flow-container';

      // A. PARENTS (Downstream - Where this goes)
      // Reverse parents so Highest Assembly is at the top
      [...parents].reverse().forEach(p => {
        flow.appendChild(createStep('is-parent', 'Used In (Parent)', p, true));
      });

      // B. CURRENT PART (Focus)
      flow.appendChild(createStep('is-focus', 'Current Part', node, false));

      // C. INPUTS (Upstream - What goes into this)
      if (inputs.length > 0) {
        inputs.forEach(inp => {
          flow.appendChild(createStep('is-child', 'Input (Material/Child)', inp, true));
        });
      } else {
        // No inputs
        const empty = document.createElement('div');
        empty.className = 'flow-step is-child';
        empty.innerHTML = `<div class="step-label">No sub-components found</div>`;
        flow.appendChild(empty);
      }

      card.appendChild(flow);
      resultsContainer.appendChild(card);
    }

    function createStep(typeClass, label, data, isClickable) {
      const el = document.createElement('div');
      el.className = `flow-step ${typeClass}`;
      
      const nameClass = isClickable ? 'part-name clickable-part' : 'part-name';
      const clickAttr = isClickable ? `onclick="jumpToPart('${data.part}')"` : '';

      el.innerHTML = `
        <div class="step-label">${label}</div>
        <div class="step-card ${typeClass === 'is-focus' ? 'focus-card' : ''}">
          <div class="${nameClass}" ${clickAttr}>${data.part}</div>
          <div class="part-desc">${data.desc || 'No description'}</div>
          <div class="part-meta">
             <span class="meta-tag">üìÇ ${friendlyCat(data.category)}</span>
             ${data.loc ? `<span class="meta-tag">üìç ${data.loc}</span>` : ''}
             ${data.sec ? `<span class="meta-tag">‚öôÔ∏è ${data.sec}</span>` : ''}
             ${data.qty ? `<span class="meta-tag">Qty: ${data.qty}</span>` : ''}
          </div>
        </div>
      `;
      return el;
    }

    function friendlyCat(cat) {
      if (!cat) return 'Unspecified';
      const map = {
        'RAW': 'Raw Material', 'LASER': 'Laser Cut', 'WELD': 'Weldment',
        'MACH': 'Machined', 'ASSM': 'Assembly', 'PURCH': 'Purchased',
        'FASTN': 'Fastener', 'ELEC': 'Electrical'
      };
      return map[cat.toUpperCase()] || cat;
    }

  </script>
</body>
</html>